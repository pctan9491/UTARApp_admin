<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Details</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
	<style>
    .comment {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
</style>

</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-0" id="assignmentTitle">Loading...</h5>
                    <h6 class="card-subtitle mb-3 text-muted" id="assignmentDueDate">Loading...</h6>
                    <div id="assignmentClasses" class="mt-4">
                        <h4>Class Details</h4>
                        <div id="classDetailsContainer" class="accordion" role="tablist"></div>
                        <button id="toggleClassDetails" class="btn btn-info mt-3" style="display: none;">
                            Show More <i class="fas fa-angle-down"></i>
                        </button>
                    </div>
                    <p class="card-text mb-4" id="assignmentDescription">Please wait, fetching details...</p>
                    <div id="assignmentImages" class="row"></div>
                    <div id="assignmentDocuments" class="mt-3"></div>
                    <a href="manageAssignment.html" class="card-link">Back to Assignments List</a>
                </div>
                <div class="card-footer">
                    <button id="likeButton" class="btn btn-outline-primary">Like</button>
                    <span id="likeCount">0 Likes</span>

<!-- Comments Section -->
    <div class="mt-4">
        <h4>Add Comment</h4>
        <div class="input-group mb-3">
            <input type="text" id="commentInput" class="form-control" placeholder="Write a comment...">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="submitComment">Post</button>
            </div>
        </div>
    </div>					

    <div id="assignmentComments" class="mt-4">
        <h4>Comments</h4>
        <div id="commentsContainer">
            <!-- Comments will be dynamically inserted here -->
        </div>
    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Your web app's Firebase configuration (the same as on your assignments list page)
var firebaseConfig = {
    apiKey: "AIzaSyBtSdg0XwU3cePNEn-HVlof8vj_imx0guA",
    authDomain: "utarapp-9f3db.firebaseapp.com",
    projectId: "utarapp-9f3db",
    storageBucket: "utarapp-9f3db.appspot.com",
    messagingSenderId: "331019317153",
    appId: "1:331019317153:web:79d3d098d6d5c3759da5e0"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

function getQueryParams() {
    var queryParams = {};
    location.search.substr(1).split("&").forEach(function(item) {
        let [key, value] = item.split("=");
        queryParams[key] = decodeURIComponent(value);
    });
    return queryParams;
}

document.addEventListener("DOMContentLoaded", function() {
    const queryParams = getQueryParams();
    const assignmentId = queryParams.assignmentId;
    const loggedInLecturerId = localStorage.getItem('saveLoginID');
    const docRef = db.collection("assignments").doc(assignmentId);

    // This function updates the UI based on the fetched assignment data
function updateUI(assignment) {
    document.getElementById("assignmentTitle").innerText = assignment.title;
    document.getElementById("assignmentDueDate").innerText = `Due Date: ${assignment.dueDate}`;
    document.getElementById("assignmentDescription").innerText = assignment.description || "No additional information provided.";
    
    // Clear existing images before adding new ones
    const imagesContainer = document.getElementById("assignmentImages");
    imagesContainer.innerHTML = ''; // Clear existing content
    if (assignment.imageUrls && assignment.imageUrls.length > 0) {
        assignment.imageUrls.forEach((url) => {
            const colDiv = document.createElement("div");
            colDiv.classList.add("col-md-4", "col-sm-6", "mb-3");
            const imgElement = document.createElement("img");
            imgElement.src = url;
            imgElement.classList.add("img-fluid", "rounded");
            colDiv.appendChild(imgElement);
            imagesContainer.appendChild(colDiv);
        });
    }

    // Clear existing documents before adding new ones
    const documentsContainer = document.getElementById("assignmentDocuments");
    documentsContainer.innerHTML = ''; // Clear existing content
    if (assignment.documentUrls && assignment.documentUrls.length > 0) {
        assignment.documentUrls.forEach((url, index) => {
            const linkElement = document.createElement("a");
            linkElement.href = url;
            linkElement.innerText = `Document ${index + 1}`;
            linkElement.classList.add("d-block", "mb-2");
            linkElement.target = "_blank";
            documentsContainer.appendChild(linkElement);
        });
    }

    // Update likes UI
    const likeButton = document.getElementById("likeButton");
    const likeCount = document.getElementById("likeCount");
    likeCount.textContent = `${assignment.likes.length} Likes`;
    likeButton.classList.toggle("btn-primary", assignment.likes.includes(loggedInLecturerId));
    likeButton.classList.toggle("btn-outline-primary", !assignment.likes.includes(loggedInLecturerId));
    likeButton.textContent = assignment.likes.includes(loggedInLecturerId) ? "Liked" : "Like";
}


    if (assignmentId) {
        // Fetch and update UI initially
        fetchAssignmentAndUpdateUI();

        // Attach the event listener for the like button only once
        document.getElementById("likeButton").addEventListener("click", function() {
            toggleLike();
        });
		
		 // Handle comment submission
        document.getElementById("submitComment").addEventListener("click", function() {
            const commentText = document.getElementById("commentInput").value.trim();
            if (!commentText) {
                alert("Please write a comment before posting.");
                return;
            }

            // Assuming you have a way to get the current user's ID; using loggedInLecturerId as placeholder
            const newComment = {
                userId: loggedInLecturerId, // This should ideally be the user's name or identifier
                commentText: commentText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Sets the timestamp on the server
				pin: false
            };
			 db.collection("assignments").doc(assignmentId).collection("comments").add(newComment)
                .then(() => {
                    document.getElementById("commentInput").value = ''; // Clear input field
                    fetchCommentsAndUpdateUI(assignmentId); // Refresh comments to include the new one
                })
                .catch(error => {
                    console.error("Error adding comment:", error);
                });
		});
    }

    function fetchAssignmentAndUpdateUI() {
        docRef.get().then((doc) => {
            if (!doc.exists) {
                console.log("No such document!");
                return;
            }
            updateUI(doc.data());
			fetchCommentsAndUpdateUI(assignmentId);
        }).catch(error => console.error("Error getting document:", error));
    }

    function toggleLike() {
        docRef.get().then((doc) => {
            if (!doc.exists) {
                console.log("No such document!");
                return;
            }
            const assignment = doc.data();
            const likes = assignment.likes || [];
            const isLiked = likes.includes(loggedInLecturerId);

            // Toggle like status
            const updatedLikes = isLiked ? likes.filter(id => id !== loggedInLecturerId) : [...likes, loggedInLecturerId];

            // Update Firestore
            docRef.update({ likes: updatedLikes }).then(() => {
                fetchAssignmentAndUpdateUI(); // Refresh UI after updating Firestore
            }).catch(error => console.error("Error updating likes:", error));
        });
    }
	
function fetchCommentsAndUpdateUI(assignmentId) {
    const commentsContainer = document.getElementById("commentsContainer");
    commentsContainer.innerHTML = ''; // Clear existing comments

    db.collection("assignments").doc(assignmentId).collection("comments")
        .orderBy("pin", "desc")
        .orderBy("timestamp", "desc") 
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                const comment = doc.data();
                const commentElement = document.createElement("div");
                commentElement.classList.add("comment");
                const commentDate = comment.timestamp ? comment.timestamp.toDate().toLocaleString() : "Unknown date";
                const pinText = comment.pin ? "<strong>[Pinned]</strong> " : "";

                commentElement.innerHTML = `
                    <p>${pinText}<strong>${comment.userId}</strong> on ${commentDate}</p>
                    <p>${comment.commentText}</p>
                    <button class="btn btn-sm btn-secondary pinCommentBtn" data-id="${doc.id}">Pin/Unpin</button>
                `;
                commentsContainer.appendChild(commentElement);
            });
        })
        .catch(error => {
            console.error("Error fetching comments:", error);
        });

    // Event delegation for Pin buttons
    commentsContainer.addEventListener('click', event => {
        if (event.target.classList.contains('pinCommentBtn')) {
            const commentId = event.target.getAttribute('data-id');
            togglePinComment(assignmentId, commentId);
        }
    });
}

// Toggle pin status of a comment
// Toggle pin status of a comment
function togglePinComment(assignmentId, commentId) {
    const commentsRef = db.collection("assignments").doc(assignmentId).collection("comments");
    
    // Step 1: Get the current status of the comment to be toggled
    commentsRef.doc(commentId).get().then(doc => {
        if (!doc.exists) {
            console.log("No such comment!");
            return;
        }
        const currentPinStatus = doc.data().pin || false;

        // Step 2: Unpin all comments
        commentsRef.get().then(snapshot => {
            let batch = db.batch();
            
            snapshot.forEach(doc => {
                batch.update(commentsRef.doc(doc.id), { pin: false });
            });

            // Step 3: Commit the batch update
            batch.commit().then(() => {
                // Step 4: If the comment was not already pinned, pin it after unpinning others
                if (!currentPinStatus) {
                    commentsRef.doc(commentId).update({ pin: true })
                        .then(() => {
                            console.log("Comment pinned successfully");
                            fetchCommentsAndUpdateUI(assignmentId); // Refresh the comments section
                        })
                        .catch(error => console.error("Error pinning the comment:", error));
                } else {
                    console.log("Comment unpinned successfully");
                    fetchCommentsAndUpdateUI(assignmentId); // Refresh the comments section if we're just unpinning
                }
            }).catch(error => console.error("Error unpinning comments:", error));
        });
    });
}


});

</script>
</body>
</html>