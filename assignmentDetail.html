<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Details</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-0" id="assignmentTitle">Loading...</h5>
                    <h6 class="card-subtitle mb-3 text-muted" id="assignmentDueDate">Loading...</h6>
                    <div id="assignmentClasses" class="mt-4">
                        <h4>Class Details</h4>
                        <div id="classDetailsContainer" class="accordion" role="tablist"></div>
                        <button id="toggleClassDetails" class="btn btn-info mt-3" style="display: none;">
                            Show More <i class="fas fa-angle-down"></i>
                        </button>
                    </div>
                    <p class="card-text mb-4" id="assignmentDescription">Please wait, fetching details...</p>
                    <div id="assignmentImages" class="row"></div>
                    <div id="assignmentDocuments" class="mt-3"></div>
                    <a href="manageAssignment.html" class="card-link">Back to Assignments List</a>
                </div>
                <div class="card-footer">
                    <button id="likeButton" class="btn btn-outline-primary">Like</button>
                    <span id="likeCount">0 Likes</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Your web app's Firebase configuration (the same as on your assignments list page)
var firebaseConfig = {
    apiKey: "AIzaSyBtSdg0XwU3cePNEn-HVlof8vj_imx0guA",
    authDomain: "utarapp-9f3db.firebaseapp.com",
    projectId: "utarapp-9f3db",
    storageBucket: "utarapp-9f3db.appspot.com",
    messagingSenderId: "331019317153",
    appId: "1:331019317153:web:79d3d098d6d5c3759da5e0"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

function getQueryParams() {
    var queryParams = {};
    location.search.substr(1).split("&").forEach(function(item) {
        let [key, value] = item.split("=");
        queryParams[key] = decodeURIComponent(value);
    });
    return queryParams;
}

document.addEventListener("DOMContentLoaded", function() {
    var queryParams = getQueryParams();
    var assignmentId = queryParams.assignmentId;
    const loggedInLecturerId = localStorage.getItem('saveLoginID');

    if(assignmentId) {
        const docRef = db.collection("assignments").doc(assignmentId);
        docRef.get().then((doc) => {
            if (doc.exists) {
                const assignment = doc.data();
                document.getElementById("assignmentTitle").innerText = assignment.title;
                document.getElementById("assignmentDueDate").innerText = `Due Date: ${assignment.dueDate}`;
                document.getElementById("assignmentDescription").innerText = assignment.description || "No additional information provided.";

                // Handle imageUrls
                const imagesContainer = document.getElementById("assignmentImages");
                if(assignment.imageUrls && assignment.imageUrls.length > 0) {
                    assignment.imageUrls.forEach((url) => {
                        // Create a column div for each image
                        const colDiv = document.createElement("div");
                        colDiv.classList.add("col-md-4", "col-sm-6", "mb-3");

                        // Create the image element
                        const imgElement = document.createElement("img");
                        imgElement.src = url;
                        imgElement.classList.add("img-fluid", "rounded");

                        // Append the image to the column div, and the column div to the images container
                        colDiv.appendChild(imgElement);
                        imagesContainer.appendChild(colDiv);
                    });
                }

                // Handle documentUrls
                const documentsContainer = document.getElementById("assignmentDocuments");
                if(assignment.documentUrls && assignment.documentUrls.length > 0) {
                    assignment.documentUrls.forEach((url, index) => {
                        const linkElement = document.createElement("a");
                        linkElement.href = url;
                        linkElement.innerText = `Document ${index + 1}`;
                        linkElement.classList.add("d-block", "mb-2");
                        linkElement.target = "_blank";
                        documentsContainer.appendChild(linkElement);
                    });
                }

                 const likeButton = document.getElementById("likeButton");
        const likeCount = document.getElementById("likeCount");
        let likes = doc.data().likes || [];
        likeCount.textContent = `${likes.length} Likes`;

        updateLikeButtonState(likes, loggedInLecturerId, likeButton);

        likeButton.addEventListener("click", () => {
            handleLikeClick(likes, loggedInLecturerId, docRef, likeButton, likeCount);
        });
            } else {
                console.log("No such document!");
            }
        }).catch((error) => {
            console.log("Error getting document:", error);
        });
		
		
		function updateLikeButtonState(likes, userId, button) {
    if (likes.includes(userId)) {
        button.classList.add("btn-primary");
        button.classList.remove("btn-outline-primary");
        button.textContent = "Liked";
    } else {
        button.classList.remove("btn-primary");
        button.classList.add("btn-outline-primary");
        button.textContent = "Like";
    }
}

function handleLikeClick(likes, userId, docRef, button, countElement) {
    const isLiked = likes.includes(userId);
    if (isLiked) {
        likes = likes.filter(id => id !== userId); // Remove like
    } else {
        likes.push(userId); // Add like
    }

    // Update Firestore
    docRef.update({likes: likes}).then(() => {
        // Update likes count and button state
        countElement.textContent = `${likes.length} Likes`;
        updateLikeButtonState(likes, userId, button);
    }).catch((error) => {
        console.error("Error updating likes:", error);
    });
}
    }
});
</script>
</body>
</html>